<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Desafio Sudoku Estratégico</title>
    <!-- Importa a fonte 'Inter' do Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            /* Paleta de Cores (Modo Claro) */
            --cor-fundo: #f4f7f9;
            --cor-container: #ffffff;
            --cor-texto-primario: #3d405b;
            --cor-texto-secundario: #555;
            --cor-borda-forte: #3d405b;
            --cor-borda-fraca: #d1d1d1;
            --cor-fundo-fixo: #edf2f4;
            --cor-fundo-selecionado: #cfe8fc;
            --cor-fundo-destacado: #e2eafc;
            --cor-texto-usuario: #0077b6;
            --cor-sucesso: #2a9d8f;
            --cor-erro: #e76f51;
            --cor-dica: #fca311;
            --sombra: 0 4px 12px rgba(0, 0, 0, 0.1);
            --cor-status-ativo: #2a9d8f;
            --cor-status-inativo: #adb5bd;

            /* Configurações das Partículas */
            --cor-particula-clara: rgba(189, 233, 235, 0.3);
            --cor-particula-escura: rgba(158, 204, 206, 0.3);
            --tamanho-particula-min: 5px;
            --tamanho-particula-max: 15px;
            --duracao-animacao-min: 15s;
            --duracao-animacao-max: 30s;
        }

        /* Paleta de Cores (Modo Escuro) */
        html.dark-mode {
            --cor-fundo: #121212;
            --cor-container: #1e1e1e;
            --cor-texto-primario: #f4f7f9;
            --cor-texto-secundario: #aaa;
            --cor-borda-forte: #f4f7f9;
            --cor-borda-fraca: #444;
            --cor-fundo-fixo: #2d2d2d;
            --cor-fundo-selecionado: #3a5a78;
            --cor-fundo-destacado: #2c3e50;
            --cor-texto-usuario: #87ceeb;
            --cor-status-inativo: #6c757d;

            /* Partículas para o modo escuro */
            --cor-particula-clara: rgba(80, 150, 250, 0.15);
            --cor-particula-escura: rgba(50, 100, 200, 0.15);
        }

        /* --- Dimensionamento Global --- */
        * {
            box-sizing: border-box; /* Garante que padding/border não afetem o tamanho final */
        }

        body {
            font-family: 'Inter', sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            background-color: var(--cor-fundo);
            color: var(--cor-texto-secundario);
            margin: 0;
            padding: 20px;
            min-height: 100vh;
            min-height: -webkit-fill-available; /* Para iOS */
            transition: background-color 0.3s, color 0.3s;
            overflow: hidden; /* Evita scrollbars das partículas */
            position: relative; /* Contexto para as partículas */
        }
        
        /* --- Partículas de Fundo --- */
        #particles-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none; /* Partículas não bloqueiam cliques */
            overflow: hidden;
            z-index: 0; /* Fica no fundo */
        }

        .particle {
            position: absolute;
            background: linear-gradient(to bottom right, var(--cor-particula-clara), var(--cor-particula-escura));
            border-radius: 50%;
            animation: floatUp var(--duracao-animacao-min) infinite ease-in-out;
            opacity: 0;
            will-change: transform, opacity;
        }

        /* Animação das partículas subindo */
        @keyframes floatUp {
            0% { transform: translateY(100vh) scale(0); opacity: 0; }
            10% { opacity: 1; }
            80% { opacity: 0.5; }
            100% { transform: translateY(-20vh) scale(1.2); opacity: 0; }
        }

        /* --- Gestão dos Ecrãs --- */
        .screen {
            display: none;
            width: 100%;
            max-width: 520px; /* Largura máxima do jogo */
            position: relative;
            z-index: 1; /* Conteúdo do jogo acima das partículas */
        }
        .screen.active {
            display: block;
        }
        
        /* --- Ecrã de Título --- */
        #title-screen.active {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            background-color: var(--cor-container);
            padding: clamp(30px, 8vw, 60px);
            border-radius: 16px;
            box-shadow: var(--sombra);
        }
        #title-screen h1 {
            color: var(--cor-texto-primario);
            font-size: clamp(2rem, 8vw, 3rem);
            margin-top: 0;
            margin-bottom: 30px;
        }
        .title-btn {
            padding: 15px 30px;
            font-size: 1.2rem;
            font-weight: bold;
            cursor: pointer;
            border: none;
            border-radius: 8px;
            width: 100%;
            max-width: 250px;
            margin-bottom: 15px;
            transition: all 0.2s ease;
        }
        #start-game-btn {
            background-color: var(--cor-borda-forte);
            color: var(--cor-container);
        }
        #start-game-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(0,0,0,0.15);
        }
        .title-btn.secondary {
            background-color: transparent;
            color: var(--cor-texto-secundario);
            border: 2px solid var(--cor-borda-fraca);
        }
        .title-btn.secondary:hover {
            background-color: var(--cor-fundo-fixo);
            border-color: var(--cor-borda-forte);
            color: var(--cor-texto-primario);
        }
        
        /* --- Ecrã de Jogo --- */
        .container {
            background-color: var(--cor-container);
            padding: clamp(15px, 4vw, 30px);
            border-radius: 16px;
            box-shadow: var(--sombra);
            text-align: center;
            width: 100%;
            transition: background-color 0.3s;
        }
        .header {
            display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;
        }
        .header h1 {
            color: var(--cor-texto-primario); margin: 0; font-size: clamp(1.5rem, 5vw, 2rem);
        }
        
        /* Botão Tema Escuro com Ícones */
        .theme-switch-wrapper { display: flex; align-items: center; }
        .theme-switch-label {
            cursor: pointer;
            font-size: 1.8rem; /* Tamanho dos ícones */
            line-height: 1;
            color: var(--cor-texto-primario);
            transition: color 0.3s;
        }
        /* Esconde o ícone que não está ativo */
        html.dark-mode .theme-switch-label .sun-icon { display: block; }
        html.dark-mode .theme-switch-label .moon-icon { display: none; }
        .theme-switch-label .sun-icon { display: none; }
        .theme-switch-label .moon-icon { display: block; }
        #theme-toggle { display: none; } /* Esconde o checkbox real */


        #difficulty-controls {
            margin-bottom: 10px; display: flex; justify-content: center; gap: 10px; flex-wrap: wrap;
        }
        .difficulty-btn {
            padding: 8px 12px; font-weight: bold; cursor: pointer; border: 2px solid var(--cor-borda-fraca);
            border-radius: 8px; color: var(--cor-texto-secundario); background-color: transparent; transition: all 0.2s;
        }
        .difficulty-btn:hover, .difficulty-btn.active { background-color: var(--cor-borda-forte); color: var(--cor-container); border-color: var(--cor-borda-forte); }
        
        #feature-status-panel {
            display: flex; justify-content: center; gap: 20px; padding: 10px;
            margin-bottom: 15px; background-color: var(--cor-fundo-fixo); border-radius: 8px;
            font-size: 0.85rem; font-weight: bold;
        }
        .feature-status span { padding: 4px 8px; border-radius: 5px; color: white; }
        .feature-status .status-active { background-color: var(--cor-status-ativo); }
        .feature-status .status-inactive { background-color: var(--cor-status-inativo); }

        .stats-bar {
            display: flex; justify-content: space-around; margin-bottom: 15px; font-weight: bold;
        }
        .stat { color: var(--cor-texto-primario); font-size: clamp(0.9rem, 3vw, 1rem); }

        /* Tabuleiro */
        #sudoku-board {
            border-collapse: collapse; border: 3px solid var(--cor-borda-forte); width: 100%;
        }
        #sudoku-board td {
            width: 11.11%; padding-bottom: 11.11%; /* Truque para manter células quadradas */
            position: relative; border: 1px solid var(--cor-borda-fraca);
        }
        /* Linhas 3x3 mais grossas */
        #sudoku-board td:nth-child(3n) { border-right: 2px solid var(--cor-borda-forte); }
        #sudoku-board tr:nth-child(3n) { border-bottom: 2px solid var(--cor-borda-forte); }

        /* Célula Individual (com Flexbox para centrar) */
        .cell {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            border: none;
            display: flex;
            align-items: center;    /* Centra verticalmente */
            justify-content: center; /* Centra horizontalmente */
            
            font-size: clamp(1.2rem, 4vw, 1.8rem);
            font-weight: bold; color: var(--cor-texto-usuario); background-color: transparent;
            padding: 0; outline: none; caret-color: transparent; cursor: pointer;
        }
        .cell.fixed { color: var(--cor-texto-primario); background-color: var(--cor-fundo-fixo); pointer-events: none; }
        .cell.selected { background-color: var(--cor-fundo-selecionado); }
        .cell.highlighted { background-color: var(--cor-fundo-destacado); }
        .cell.error { animation: shake 0.5s; }
        @keyframes shake { 0%, 100% {transform: translateX(0);} 25% {transform: translateX(-4px);} 75% {transform: translateX(4px);}}

        /* Teclado Numérico */
        .numpad-container { display: flex; justify-content: center; gap: 5px; margin-top: 20px; flex-wrap: wrap; }
        .numpad-btn {
            width: clamp(35px, 9vw, 45px); height: clamp(35px, 9vw, 45px); font-size: 1.5em; font-weight: bold;
            cursor: pointer; border-radius: 8px; border: 1px solid var(--cor-borda-fraca);
            background-color: var(--cor-fundo-fixo); color: var(--cor-texto-primario);
        }

        /* Botões de Ação (sem "Recomeçar") */
        .action-controls { margin-top: 20px; display: flex; gap: 15px; justify-content: center; }
        .action-btn {
            padding: 10px 20px; font-size: 1em; font-weight: bold; cursor: pointer;
            border: none; border-radius: 8px; color: white;
        }
        #hint-btn { background-color: var(--cor-dica); }
        #check-btn { background-color: var(--cor-sucesso); }
        
        .hidden { display: none !important; }

        /* --- Modais (Janelas Pop-up) --- */
        .modal {
            display: none; position: fixed; z-index: 100; left: 0; top: 0; width: 100%; height: 100%;
            background-color: rgba(0,0,0,0.6); justify-content: center; align-items: center; padding: 20px;
        }
        .modal-content {
            background-color: var(--cor-container); color: var(--cor-texto-primario); padding: 30px;
            border-radius: 16px; text-align: center; box-shadow: 0 5px 20px rgba(0,0,0,0.4);
            max-width: 500px;
            width: 100%;
        }
        .modal-content h2 { margin-top: 0; }
        .modal-content button { margin-top: 20px; background-color: var(--cor-borda-forte); color: var(--cor-container); }
        
        #victory-modal h2 { color: var(--cor-sucesso); }
        
        #rules-modal .modal-content, #ranking-modal .modal-content { text-align: left; }
        #rules-modal h2, #ranking-modal h2 { color: var(--cor-texto-primario); text-align: center; }
        #rules-modal ul { padding-left: 20px; margin-top: 15px; line-height: 1.6; }
        #rules-modal ul li { margin-bottom: 10px; }
        #rules-modal strong { color: var(--cor-texto-primario); }

        .ranking-list {
            list-style: none; padding: 0; margin-top: 20px; font-size: 1.1rem;
        }
        .ranking-list li {
            display: flex; justify-content: space-between; padding: 10px 0;
            border-bottom: 1px solid var(--cor-borda-fraca);
        }
        .ranking-list li:last-child { border-bottom: none; }
        .ranking-list strong { color: var(--cor-texto-primario); }
        
        /* --- Media Queries para Responsividade --- */

        /* Para telas de telemóveis (ex: 480px ou menos) */
        @media (max-width: 480px) {
            body {
                padding: 10px;
                min-height: 100vh;
            }

            .container {
                padding: clamp(10px, 3vw, 20px);
            }

            #feature-status-panel {
                flex-wrap: wrap; /* Permite quebrar linha */
                gap: 10px; /* Adiciona espaçamento se quebrar */
            }

            .header h1 {
                 font-size: clamp(1.3rem, 5vw, 1.5rem);
            }

            .title-btn {
                padding: 12px 20px;
                font-size: 1rem;
            }

            #title-screen.active {
                padding: clamp(20px, 6vw, 40px);
            }

            .stats-bar {
                margin-bottom: 10px;
                flex-wrap: wrap;
                gap: 5px 10px;
            }

            .stat {
                font-size: clamp(0.8rem, 3vw, 0.9rem);
            }

            .cell {
                font-size: clamp(1.1rem, 5.5vw, 1.6rem);
            }

            .numpad-container {
                margin-top: 15px;
                gap: 3px;
            }

            .numpad-btn {
                width: clamp(30px, 9vw, 38px);
                height: clamp(30px, 9vw, 38px);
                font-size: clamp(1rem, 4vw, 1.2rem);
            }

            .action-controls {
                margin-top: 15px;
                gap: 10px;
                flex-wrap: wrap;
            }
            .action-btn {
                padding: 10px 15px;
                font-size: 0.9em;
                flex-grow: 1;
                text-align: center;
                flex-basis: 120px;
            }
            
            .modal-content {
                padding: 20px;
                width: 95%;
            }

            .ranking-list {
                font-size: 1rem;
            }
        }
        
    </style>
</head>
<body>
    
    <!-- Contentor para as partículas de fundo -->
    <div id="particles-container"></div>

    <!-- ECRÃ DE TÍTULO -->
    <div id="title-screen" class="screen active">
        <h1>Sudoku Estratégico</h1>
        <button id="start-game-btn" class="title-btn">Iniciar Jogo</button>
        <button id="show-rules-btn" class="title-btn secondary">Regras</button>
        <button id="show-ranking-btn" class="title-btn secondary">Meus Recordes</button>
    </div>

    <!-- ECRÃ PRINCIPAL DO JOGO -->
    <div id="game-container" class="screen">
        <div class="container">
            <!-- Cabeçalho com Título e Botão de Tema -->
            <div class="header">
                <h1>Sudoku Estratégico</h1>
                <div class="theme-switch-wrapper">
                    <input type="checkbox" id="theme-toggle" />
                    <label class="theme-switch-label" for="theme-toggle">
                        <span class="sun-icon">☀️</span>
                        <span class="moon-icon">🌙</span>
                    </label>
                </div>
            </div>
            
            <!-- Botões de Dificuldade -->
            <div id="difficulty-controls">
                <button class="difficulty-btn active" data-level="facil">Fácil</button>
                <button class="difficulty-btn" data-level="medio">Médio</button>
                <button class="difficulty-btn" data-level="dificil">Difícil</button>
            </div>
            
            <!-- Painel de Status das Funcionalidades -->
            <div id="feature-status-panel">
                <div class="feature-status">Dicas Visuais: <span id="visual-hints-status"></span></div>
                <div class="feature-status">Verificação de Erros: <span id="error-check-status"></span></div>
            </div>

            <!-- Estatísticas (Tempo, Erros, Recorde) -->
            <div class="stats-bar">
                <div class="stat">Tempo: <span id="timer">00:00</span></div>
                <div id="mistakes-stat" class="stat hidden">Erros: <span id="mistakes">0/5</span></div>
                <div class="stat">Recorde: <span id="personal-best">--:--</span></div>
            </div>
            
            <!-- O Tabuleiro do Sudoku -->
            <table id="sudoku-board"></table>
            
            <!-- Teclado Numérico -->
            <div class="numpad-container" id="numpad"></div>
            
            <!-- Botões de Ação (Dica, Verificar) -->
            <div class="action-controls">
                <button id="hint-btn" class="action-btn">Dica (<span id="hints-left">3</span>)</button>
                <button id="check-btn" class="action-btn hidden">Verificar</button>
            </div>
        </div>
    </div>
    
    <!-- MODAL DE VITÓRIA -->
    <div id="victory-modal" class="modal">
        <div class="modal-content">
            <h2>Vitória!</h2>
            <p>Completou o Sudoku em <strong id="final-time"></strong>!</p>
            <p id="new-record-message" class="hidden" style="color: var(--cor-sucesso); font-weight: bold;">Novo Recorde Pessoal!</p>
            <button class="action-btn" id="play-again-btn">Jogar Novamente</button>
        </div>
    </div>
    
    <!-- MODAL DE REGRAS -->
    <div id="rules-modal" class="modal">
        <div class="modal-content">
            <h2>Regras do Sudoku</h2>
            <p>O objetivo é preencher a grelha 9x9 com números de 1 a 9, de forma que:</p>
            <ul>
                <li>Cada <strong>linha</strong> contenha todos os números de 1 a 9, sem repetições.</li>
                <li>Cada <strong>coluna</strong> contenha todos os números de 1 a 9, sem repetições.</li>
                <li>Cada <strong>bloco 3x3</strong> contenha todos os números de 1 a 9, sem repetições.</li>
            </ul>
            <p><strong>Funcionalidades deste jogo:</strong></p>
            <ul>
                <li><strong>Fácil:</strong> Tem "Dicas Visuais" ativas (clicar numa célula destaca números iguais).</li>
                <li><strong>Médio:</strong> Um desafio puro, sem ajudas visuais.</li>
                <li><strong>Difícil:</strong> Permite "Verificação de Erros" manual (botão "Verificar"), mas tem um limite de 5 erros!</li>
            </ul>
            <button class="action-btn" id="close-rules-btn">Fechar</button>
        </div>
    </div>

    <!-- MODAL DE RECORDES -->
    <div id="ranking-modal" class="modal">
        <div class="modal-content">
            <h2>Meus Recordes</h2>
            <ul class="ranking-list">
                <li><strong>Fácil:</strong> <span id="ranking-facil">--:--</span></li>
                <li><strong>Médio:</strong> <span id="ranking-medio">--:--</span></li>
                <li><strong>Difícil:</strong> <span id="ranking-dificil">--:--</span></li>
            </ul>
            <button class="action-btn" id="close-ranking-btn">Fechar</button>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Base de dados de Quebra-cabeças
            const puzzles = {
                facil: [{ puzzle: [[5,3,0,0,7,0,0,0,0],[6,0,0,1,9,5,0,0,0],[0,9,8,0,0,0,0,6,0],[8,0,0,0,6,0,0,0,3],[4,0,0,8,0,3,0,0,1],[7,0,0,0,2,0,0,0,6],[0,6,0,0,0,0,2,8,0],[0,0,0,4,1,9,0,0,5],[0,0,0,0,8,0,0,7,9]], solution: [[5,3,4,6,7,8,9,1,2],[6,7,2,1,9,5,3,4,8],[1,9,8,3,4,2,5,6,7],[8,5,9,7,6,1,4,2,3],[4,2,6,8,5,3,7,9,1],[7,1,3,9,2,4,8,5,6],[9,6,1,5,3,7,2,8,4],[2,8,7,4,1,9,6,3,5],[3,4,5,2,8,6,1,7,9]]},
                        { puzzle: [[0,0,0,2,6,0,7,0,1],[6,8,0,0,7,0,0,9,0],[1,9,0,0,0,4,5,0,0],[8,2,0,1,0,0,0,4,0],[0,0,4,6,0,2,9,0,0],[0,5,0,0,0,3,0,2,8],[0,0,9,3,0,0,0,7,4],[0,4,0,0,5,0,0,3,6],[7,0,3,0,1,8,0,0,0]], solution: [[4,3,5,2,6,9,7,8,1],[6,8,2,5,7,1,4,9,3],[1,9,7,8,3,4,5,6,2],[8,2,6,1,9,7,3,4,5],[3,7,4,6,8,2,9,5,1],[9,5,1,4,3,3,6,2,8],[5,1,9,3,2,6,8,7,4],[2,4,8,9,5,7,1,3,6],[7,6,3,1,1,8,2,5,9]]}],
                medio: [{ puzzle: [[0,2,0,6,0,8,0,0,0],[5,8,0,0,0,9,7,0,0],[0,0,0,0,4,0,0,0,0],[3,7,0,0,0,0,5,0,0],[6,0,0,0,0,0,0,0,4],[0,0,8,0,0,0,0,1,3],[0,0,0,0,2,0,0,0,0],[0,0,9,8,0,0,0,3,6],[0,0,0,3,0,6,0,9,0]], solution: [[1,2,3,6,7,8,9,4,5],[5,8,4,2,3,9,7,6,1],[9,6,7,1,4,5,3,2,8],[3,7,1,9,8,4,5,2,6],[6,9,2,5,1,3,8,7,4],[4,5,8,7,6,2,9,1,3],[8,3,6,4,2,1,7,5,9],[7,1,9,8,5,2,4,3,6],[2,4,5,3,9,6,1,8,7]]},
                        { puzzle: [[0,0,0,0,0,0,0,1,2],[0,0,0,0,3,5,0,0,0],[0,0,0,6,0,1,0,7,0],[0,0,7,0,0,0,0,0,0],[0,4,0,0,0,0,0,2,0],[0,0,0,0,0,0,8,0,0],[0,1,0,5,0,9,0,0,0],[0,0,0,1,8,0,0,0,0],[3,9,0,0,0,0,0,4,0]], solution: [[6,7,5,8,9,4,3,1,2],[1,2,9,7,3,5,4,8,6],[4,8,3,6,2,1,9,7,5],[8,5,7,2,1,3,6,9,4],[9,4,1,8,6,7,5,2,3],[2,3,6,9,5,4,8,1,7],[7,1,4,5,2,9,6,3,8],[5,6,2,1,8,3,7,4,9],[3,9,8,4,7,6,2,5,1]]}],
                dificil: [{ puzzle: [[8,0,0,0,0,0,0,0,0],[0,0,3,6,0,0,0,0,0],[0,7,0,0,9,0,2,0,0],[0,5,0,0,0,7,0,0,0],[0,0,0,0,4,5,7,0,0],[0,0,0,1,0,0,0,3,0],[0,0,1,0,0,0,0,6,8],[0,0,8,5,0,0,0,1,0],[0,9,0,0,0,0,4,0,0]], solution: [[8,1,2,7,5,3,6,4,9],[9,4,3,6,8,2,1,7,5],[6,7,5,4,9,1,2,8,3],[1,5,4,2,3,7,8,9,6],[3,6,9,8,4,5,7,2,1],[2,8,7,1,6,9,5,3,4],[5,2,1,9,7,4,3,6,8],[4,3,8,5,2,6,9,1,7],[7,9,6,3,1,8,4,5,2]]},
                        { puzzle: [[0,0,0,8,0,1,0,0,0],[0,0,0,0,0,0,0,4,3],[5,0,0,0,0,0,0,0,0],[0,0,0,0,7,0,8,0,0],[0,0,0,0,0,0,1,0,0],[0,2,0,0,3,0,0,0,0],[6,0,0,0,0,0,0,7,5],[0,0,3,4,0,0,0,0,0],[0,0,0,2,0,0,6,0,0]], solution: [[3,4,2,8,6,1,5,9,7],[1,6,7,9,5,2,8,4,3],[5,8,9,3,4,7,2,6,1],[4,3,1,5,7,6,8,2,9],[7,9,6,8,2,4,1,3,5],[8,2,5,1,3,9,7,5,4],[6,1,8,2,5,3,4,7,5],[2,5,3,4,1,8,9,7,6],[9,7,4,2,6,5,6,1,8]]}]
            };

            // --- Elementos DOM ---
            const boardElement = document.getElementById('sudoku-board');
            const timerElement = document.getElementById('timer');
            const mistakesElement = document.getElementById('mistakes');
            const mistakesStat = document.getElementById('mistakes-stat');
            const checkBtn = document.getElementById('check-btn');
            const visualHintsStatus = document.getElementById('visual-hints-status');
            const errorCheckStatus = document.getElementById('error-check-status');
            
            // Ecrãs
            const titleScreen = document.getElementById('title-screen');
            const gameContainer = document.getElementById('game-container');
            
            // Modais
            const rulesModal = document.getElementById('rules-modal');
            const victoryModal = document.getElementById('victory-modal');
            const rankingModal = document.getElementById('ranking-modal');

            // --- Estado do Jogo ---
            let currentPuzzle, currentSolution, selectedCell = null, timerInterval, totalSeconds = 0, mistakes = 0, hintsLeft = 3;
            const MAX_MISTAKES = 5;
            let currentLevel = 'facil';
            
            // --- Funções Principais do Jogo ---
            
            // Inicia/Reinicia o cronómetro
            function startTimer() { 
                stopTimer(); // Limpa qualquer temporizador anterior
                totalSeconds = 0; 
                timerElement.textContent = '00:00';
                timerInterval = setInterval(() => { 
                    totalSeconds++; 
                    const minutes = Math.floor(totalSeconds / 60); 
                    const seconds = totalSeconds % 60; 
                    timerElement.textContent = formatTime(totalSeconds); 
                }, 1000); 
            }
            // Para o cronómetro
            function stopTimer() { clearInterval(timerInterval); }

            // Prepara o jogo para um nível
            function initGame(level) {
                currentLevel = level;
                updateFeatureUI(level); // Atualiza o painel de funcionalidades
                
                // Seleciona um puzzle aleatório para o nível
                const levelPuzzles = puzzles[level];
                const puzzleData = levelPuzzles[Math.floor(Math.random() * levelPuzzles.length)];
                currentPuzzle = puzzleData.puzzle.map(row => [...row]);
                currentSolution = puzzleData.solution;

                // Reseta estatísticas
                mistakes = 0; hintsLeft = 3;
                mistakesElement.textContent = `${mistakes}/${MAX_MISTAKES}`;
                document.getElementById('hints-left').textContent = hintsLeft;
                
                updatePersonalBestDisplay(); // Mostra o recorde atual
                createBoard(); // Desenha o tabuleiro
                
                stopTimer(); // Garante que o cronómetro está parado
                timerElement.textContent = '00:00'; // Reseta o mostrador
            }

            // Atualiza o painel de "Dicas Visuais" e "Verificação de Erros"
            function updateFeatureUI(level) {
                if (level === 'facil') {
                    visualHintsStatus.textContent = 'ATIVO'; visualHintsStatus.className = 'status-active';
                    errorCheckStatus.textContent = 'INATIVO'; errorCheckStatus.className = 'status-inactive';
                    mistakesStat.classList.add('hidden'); checkBtn.classList.add('hidden');
                } else if (level === 'medio') {
                    visualHintsStatus.textContent = 'INATIVO'; visualHintsStatus.className = 'status-inactive';
                    errorCheckStatus.textContent = 'INATIVO'; errorCheckStatus.className = 'status-inactive';
                    mistakesStat.classList.add('hidden'); checkBtn.classList.add('hidden');
                } else { // dificil
                    visualHintsStatus.textContent = 'INATIVO'; visualHintsStatus.className = 'status-inactive';
                    errorCheckStatus.textContent = 'ATIVO'; errorCheckStatus.className = 'status-active';
                    mistakesStat.classList.remove('hidden'); checkBtn.classList.remove('hidden');
                }
            }
            
            // Cria o tabuleiro 9x9
            function createBoard() {
                boardElement.innerHTML = '';
                for (let i = 0; i < 9; i++) {
                    const row = document.createElement('tr');
                    for (let j = 0; j < 9; j++) {
                        const cell = document.createElement('td');
                        const input = document.createElement('div');
                        input.classList.add('cell');
                        input.dataset.row = i; input.dataset.col = j;
                        if (currentPuzzle[i][j] !== 0) {
                            input.textContent = currentPuzzle[i][j];
                            input.classList.add('fixed'); // Célula fixa
                        } else {
                            input.addEventListener('click', () => onCellClick(input)); // Célula clicável
                        }
                        cell.appendChild(input);
                        row.appendChild(cell);
                    }
                    boardElement.appendChild(row);
                }
            }

            // Evento de clique numa célula
            function onCellClick(cell) {
                if (selectedCell) selectedCell.classList.remove('selected');
                selectedCell = cell;
                selectedCell.classList.add('selected');
                
                // Destaque de números (só no fácil)
                if (currentLevel === 'facil') {
                    highlightNumbers(selectedCell.textContent);
                }
            }

            // Insere um número do teclado numérico
            function insertNumber(num) {
                if (!selectedCell || selectedCell.classList.contains('fixed')) return;
                selectedCell.textContent = num;
                
                if (currentLevel === 'facil') {
                    highlightNumbers(num);
                }
                checkWin(); // Verifica se o jogo terminou
            }

            // Verifica erros (só no difícil)
            function checkHardLevelErrors() {
                if (currentLevel !== 'dificil') return;
                let errorsFound = 0;
                document.querySelectorAll('.cell:not(.fixed)').forEach(cell => {
                    if (cell.textContent) {
                        const row = cell.dataset.row; const col = cell.dataset.col;
                        if (cell.textContent != currentSolution[row][col]) {
                            errorsFound++;
                            cell.classList.add('error'); // Animação de erro
                            setTimeout(() => cell.classList.remove('error'), 500);
                        }
                    }
                });
                if (errorsFound > 0) {
                    mistakes += errorsFound; // A contagem de erros AUMENTA AQUI
                    mistakesElement.textContent = `${mistakes}/${MAX_MISTAKES}`;
                    if (mistakes >= MAX_MISTAKES) {
                        stopTimer();
                        alert("Limite de erros atingido! A recomeçar o nível.");
                        initGame(currentLevel); 
                        startTimer();
                    }
                } else {
                   checkWin(); // Se não houver erros, verifica se ganhou
                }
            }

            // Verifica se o tabuleiro está completo e correto
            function checkWin() {
                const cells = document.querySelectorAll('.cell');
                for (const cell of cells) {
                    const row = cell.dataset.row; const col = cell.dataset.col;
                    if (!cell.textContent || cell.textContent != currentSolution[row][col]) {
                        return; // Não ganhou
                    }
                }
                // Se chegou aqui, ganhou
                stopTimer();
                showVictoryScreen();
            }

            // Destaque de números (só no fácil)
            function highlightNumbers(num) {
                document.querySelectorAll('.cell').forEach(cell => cell.classList.remove('highlighted'));
                if (num) {
                    document.querySelectorAll('.cell').forEach(cell => {
                        if (cell.textContent == num) cell.classList.add('highlighted');
                    });
                }
            }

            // --- Funções de Ajuda, UI e Estado ---
            
            // Limpa a célula selecionada
            function clearSelectedCell() { 
                if(selectedCell && !selectedCell.classList.contains('fixed')) { 
                    selectedCell.textContent = ''; 
                    if (currentLevel === 'facil') highlightNumbers(''); 
                } 
            }
            
            // Dá uma dica
            function giveHint() { 
                if (hintsLeft <= 0) return; 
                const emptyCells = Array.from(document.querySelectorAll('.cell:not(.fixed)')).filter(c => !c.textContent); 
                if (emptyCells.length === 0) return; 
                const randomCell = emptyCells[Math.floor(Math.random() * emptyCells.length)]; 
                const row = randomCell.dataset.row; const col = randomCell.dataset.col; 
                randomCell.textContent = currentSolution[row][col]; 
                hintsLeft--; 
                document.getElementById('hints-left').textContent = hintsLeft; 
                checkWin(); 
            }
            
            // Mostra a tela de vitória
            function showVictoryScreen() { 
                document.getElementById('final-time').textContent = timerElement.textContent; 
                document.getElementById('new-record-message').classList.toggle('hidden', !updatePersonalBest()); 
                victoryModal.style.display = 'flex'; 
            }
            
            // Atualiza o recorde pessoal se for melhor
            function updatePersonalBest() { 
                const bestTime = localStorage.getItem(`sudokuBestTime_${currentLevel}`); 
                if (!bestTime || totalSeconds < bestTime) { 
                    localStorage.setItem(`sudokuBestTime_${currentLevel}`, totalSeconds); 
                    updatePersonalBestDisplay(); 
                    return true; // É um novo recorde
                } 
                return false; // Não é um novo recorde
            }
            
            // Mostra o recorde pessoal na tela
            function updatePersonalBestDisplay() { 
                const personalBestElement = document.getElementById('personal-best'); 
                const bestTime = localStorage.getItem(`sudokuBestTime_${currentLevel}`); 
                personalBestElement.textContent = bestTime ? formatTime(bestTime) : '--:--';
            }

            // Formata segundos para MM:SS
            function formatTime(seconds) {
                const minutes = Math.floor(seconds / 60);
                const secs = seconds % 60;
                return `${String(minutes).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
            }

            // Mostra o modal de recordes
            function showRankingModal() {
                document.getElementById('ranking-facil').textContent = localStorage.getItem('sudokuBestTime_facil') ? formatTime(localStorage.getItem('sudokuBestTime_facil')) : '--:--';
                document.getElementById('ranking-medio').textContent = localStorage.getItem('sudokuBestTime_medio') ? formatTime(localStorage.getItem('sudokuBestTime_medio')) : '--:--';
                document.getElementById('ranking-dificil').textContent = localStorage.getItem('sudokuBestTime_dificil') ? formatTime(localStorage.getItem('sudokuBestTime_dificil')) : '--:--';
                rankingModal.style.display = 'flex';
            }

            // Cria o teclado numérico
            function createNumpad() { 
                const numpadContainer = document.getElementById('numpad'); 
                numpadContainer.innerHTML = ''; 
                for (let i = 1; i <= 9; i++) { 
                    const btn = document.createElement('button'); btn.textContent = i; btn.classList.add('numpad-btn'); 
                    btn.addEventListener('click', () => insertNumber(i)); 
                    numpadContainer.appendChild(btn); 
                } 
                const clearBtn = document.createElement('button'); clearBtn.textContent = 'X'; clearBtn.classList.add('numpad-btn'); 
                clearBtn.addEventListener('click', clearSelectedCell); 
                numpadContainer.appendChild(clearBtn); 
            }
            
            // Lógica do Tema Escuro
            const themeToggle = document.getElementById('theme-toggle'); 
            themeToggle.addEventListener('change', () => { 
                document.documentElement.classList.toggle('dark-mode'); 
                localStorage.setItem('theme', document.documentElement.classList.contains('dark-mode') ? 'dark' : 'light'); 
            }); 
            if (localStorage.getItem('theme') === 'dark') { 
                document.documentElement.classList.add('dark-mode'); 
                themeToggle.checked = true; 
            }

            // --- Gerador de Partículas ---
            const particlesContainer = document.getElementById('particles-container');
            const numParticles = 60; // Aumentado para 60
            for (let i = 0; i < numParticles; i++) {
                const particle = document.createElement('div');
                particle.classList.add('particle');

                const size = Math.random() * (parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--tamanho-particula-max')) - parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--tamanho-particula-min'))) + parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--tamanho-particula-min'));
                const duration = Math.random() * (parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--duracao-animacao-max')) - parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--duracao-animacao-min'))) + parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--duracao-animacao-min'));
                const delay = Math.random() * duration;
                const left = Math.random() * 100; // Posição horizontal aleatória

                particle.style.width = `${size}px`;
                particle.style.height = `${size}px`;
                particle.style.left = `${left}%`;
                particle.style.animationDuration = `${duration}s`;
                particle.style.animationDelay = `${delay}s`;
                particle.style.opacity = Math.random() * 0.5 + 0.1; // Opacidade inicial variada

                particlesContainer.appendChild(particle);
            }


            // --- Event Listeners (Controlos de Navegação e Jogo) ---
            
            // Navegação e Ecrãs
            document.getElementById('start-game-btn').addEventListener('click', () => {
                titleScreen.classList.remove('active');
                gameContainer.classList.add('active');
                startTimer(); // Inicia o temporizador do jogo
            });
            document.getElementById('show-rules-btn').addEventListener('click', () => {
                rulesModal.style.display = 'flex';
            });
            document.getElementById('close-rules-btn').addEventListener('click', () => {
                rulesModal.style.display = 'none';
            });
            document.getElementById('show-ranking-btn').addEventListener('click', showRankingModal);
            document.getElementById('close-ranking-btn').addEventListener('click', () => {
                rankingModal.style.display = 'none';
            });

            // Controlos do Jogo
            document.querySelectorAll('.difficulty-btn').forEach(button => { 
                button.addEventListener('click', () => { 
                    document.querySelector('.difficulty-btn.active').classList.remove('active'); 
                    button.classList.add('active'); 
                    initGame(button.dataset.level); // Prepara o jogo
                    startTimer(); // Inicia o temporizador
                }); 
            });
            checkBtn.addEventListener('click', checkHardLevelErrors);
            document.getElementById('hint-btn').addEventListener('click', giveHint);
            
            // Botão "Jogar Novamente" no modal de vitória
            document.getElementById('play-again-btn').addEventListener('click', () => { 
                victoryModal.style.display = 'none'; 
                initGame(currentLevel); // Prepara o jogo
                startTimer(); // Inicia o temporizador
            });
            
            // --- Inicialização ---
            createNumpad(); // Cria o teclado
            initGame('facil'); // Prepara o jogo no nível fácil (sem iniciar o temporizador)
        });
    </script>
</body>
</html>

