<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Perfil do Usu√°rio - Atividade Adaptada</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts: Nunito, uma fonte amig√°vel e leg√≠vel -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;700;800&display=swap" rel="stylesheet">
    <style>
        /* Aplicando a fonte Nunito como padr√£o para todo o corpo do site */
        body {
            font-family: 'Nunito', sans-serif;
            background-color: #f8fafc; /* Um cinza muito claro para o fundo */
        }
        /* Efeito de sombra e escala para os cards, tornando-os mais interativos */
        .card-hover {
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }
        .card-hover:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
    </style>
</head>
<body class="text-gray-800">

    <!-- Cabe√ßalho e Navega√ß√£o -->
    <header class="bg-white shadow-sm sticky top-0 z-50">
        <nav class="container mx-auto px-6 py-4 flex justify-between items-center">
            <a href="index.html" class="text-2xl font-extrabold">
                <span class="text-red-600">Atividade</span><span class="text-blue-600">Adaptada</span><span class="text-gray-900">.com</span>
            </a>
            <div class="hidden md:flex items-center space-x-6">
                <a href="index.html" class="font-bold text-cyan-600">In√≠cio</a>
                <a href="Nivel 2/categorias.html" class="text-gray-600 hover:text-cyan-500 transition">Atividades</a>
                <a href="Nivel 2/1-pagina inicial/1-Paginas/Artigos.html" class="text-gray-600 hover:text-cyan-500 transition">Artigos</a>
                <a href="Nivel 2/6-Quem Somos.html" class="text-gray-600 hover:text-cyan-500 transition">Sobre N√≥s</a>
            </div>
            <button onclick="handleLogout()" class="hidden md:block bg-orange-500 text-white font-bold py-2 px-5 rounded-full hover:bg-orange-600 transition">
                Sair
            </button>
            <button id="mobile-menu-button" class="md:hidden">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7" /></svg>
            </button>
        </nav>
        <div id="mobile-menu" class="hidden md:hidden px-6 pb-4">
            <a href="index.html" class="block py-2 font-bold text-cyan-600">In√≠cio</a>
            <a href="Nivel 2/categorias.html" class="block py-2 text-gray-600 hover:text-cyan-500">Atividades</a>
            <a href="Nivel 2/1-pagina inicial/1-Paginas/Artigos.html" class="block py-2 text-gray-600 hover:text-cyan-500">Artigos</a>
            <a href="Nivel 2/6-Quem Somos.html" class="block py-2 text-gray-600 hover:text-cyan-500">Sobre N√≥s</a>
            <button onclick="handleLogout()" class="block mt-4 bg-orange-500 text-white font-bold py-2 px-5 rounded-full text-center w-full">Sair</button>
        </div>
    </header>

    <div class="flex items-center justify-center p-4 min-h-screen pt-20">
  

    <div class="bg-white w-full max-w-4xl rounded-3xl shadow-2xl overflow-hidden card-hover">
        <!-- Header -->
        <div class="p-8 text-center bg-gray-50 border-b border-gray-100">
            <h1 class="text-3xl font-bold text-gray-800">Perfil do Usu√°rio</h1>
            <p id="user-status" class="text-gray-500 mt-2 text-sm">Carregando...</p>
        </div>

        <!-- Conte√∫do do Perfil -->
        <div id="profile-container" class="p-8 hidden">
            <div class="flex flex-col items-center mb-8">
                <div id="user-photo-container" class="mb-4 relative">
                    <img id="user-photo" src="" class="w-24 h-24 rounded-full border-4 border-indigo-100 hidden">
                    <div id="user-initial" class="w-24 h-24 bg-indigo-100 text-indigo-600 rounded-full flex items-center justify-center text-3xl font-bold">U</div>
                    <button onclick="selectPhoto()" class="absolute bottom-0 right-0 bg-indigo-600 text-white p-2 rounded-full shadow-lg hover:bg-indigo-700 transition-all">
                        üì∑
                    </button>
                </div>
                <input type="file" id="photo-input" accept="image/*" style="display: none;">
                <h2 id="user-name" class="text-2xl font-bold text-gray-800">Usu√°rio</h2>
                <p id="user-email" class="text-gray-500"></p>
                <p id="user-role" class="text-indigo-600 font-medium">Membro</p>
            </div>

            <!-- Bot√µes de A√ß√£o -->
            <div class="flex gap-4 justify-center mb-8">
                <button onclick="editProfile()" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-xl transition-all">
                    Editar Perfil
                </button>
                <button onclick="handleLogout()" class="border-2 border-red-100 text-red-500 hover:bg-red-50 font-bold py-2 px-4 rounded-xl transition-all">
                    Sair
                </button>
            </div>

            <!-- Se√ß√£o de Edi√ß√£o (oculta por padr√£o) -->
            <div id="edit-section" class="hidden mb-8">
                <h3 class="text-xl font-bold mb-4">Editar Perfil</h3>
                <form id="edit-form" class="space-y-4">
                    <input type="text" id="edit-name" placeholder="Nome" class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:ring-2 focus:ring-indigo-500 outline-none">
                    <textarea id="edit-bio" placeholder="Biografia" class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:ring-2 focus:ring-indigo-500 outline-none h-24"></textarea>
                    <button type="submit" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 rounded-xl shadow-lg transition-all">
                        Salvar
                    </button>
                </form>
            </div>

            <!-- Estat√≠sticas -->
            <div class="grid grid-cols-3 gap-4 mb-8">
                <div class="bg-indigo-50 p-4 rounded-xl text-center">
                    <p id="activities-count" class="text-2xl font-bold text-indigo-600">0</p>
                    <p class="text-sm text-indigo-400">Atividades</p>
                </div>
                <div class="bg-amber-50 p-4 rounded-xl text-center">
                    <p id="favorites-count" class="text-2xl font-bold text-amber-600">0</p>
                    <p class="text-sm text-amber-400">Favoritos</p>
                </div>
                <div class="bg-rose-50 p-4 rounded-xl text-center">
                    <p id="articles-count" class="text-2xl font-bold text-rose-600">0</p>
                    <p class="text-sm text-rose-400">Artigos</p>
                </div>
            </div>

            <!-- Abas -->
            <div class="flex bg-white p-1.5 rounded-3xl shadow-sm border border-gray-200 mb-6">
                <button onclick="showTab('activities')" id="tab-activities" class="flex-1 py-2 px-4 rounded-2xl font-bold text-sm transition-all bg-indigo-600 text-white">
                    Atividades
                </button>
                <button onclick="showTab('favorites')" id="tab-favorites" class="flex-1 py-2 px-4 rounded-2xl font-bold text-sm transition-all text-gray-500 hover:bg-gray-50">
                    Favoritos
                </button>
                <button onclick="showTab('articles')" id="tab-articles" class="flex-1 py-2 px-4 rounded-2xl font-bold text-sm transition-all text-gray-500 hover:bg-gray-50">
                    Artigos
                </button>
            </div>

            <!-- Conte√∫do das Abas -->
            <div id="tab-content">
                <div id="activities-list" class="space-y-4">
                    <p class="text-center text-gray-500">Nenhuma atividade encontrada.</p>
                </div>
                <div id="favorites-list" class="space-y-4 hidden">
                    <p class="text-center text-gray-500">Nenhum favorito encontrado.</p>
                </div>
                <div id="articles-list" class="space-y-4 hidden">
                    <p class="text-center text-gray-500">Nenhum artigo encontrado.</p>
                </div>
            </div>
        </div>

        <!-- Box de Alertas -->
        <div id="message-box" class="hidden mx-8 mb-8 p-3 rounded-lg text-sm text-center"></div>
    </div>

    <!-- Scripts -->
    <script>
        // Menu mobile
        document.getElementById('mobile-menu-button').addEventListener('click', () => {
            document.getElementById('mobile-menu').classList.toggle('hidden');
        });
    </script>

    <!-- Scripts Firebase -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            onAuthStateChanged, 
            signOut
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            setDoc, 
            onSnapshot, 
            collection,
            updateDoc
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDmMuftAqoUBEoGHXtV0C_SZVHp5KmdNn4",
            authDomain: "atividadeadaptada.firebaseapp.com",
            projectId: "atividadeadaptada",
            storageBucket: "atividadeadaptada.firebasestorage.app",
            messagingSenderId: "37982590936",
            appId: "1:37982590936:web:f0bd7b5c5dd208e26a84ad"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let currentUser = null;
        let profileData = {};

        // Verificar autentica√ß√£o
        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                loadUserProfile();
                document.getElementById('profile-container').classList.remove('hidden');
                document.getElementById('user-status').innerText = "Perfil carregado";
            } else {
                // Se n√£o logado, redirecionar para login
                window.location.href = 'login.html';
            }
        });

        // Carregar perfil do usu√°rio
        function loadUserProfile() {
            if (!currentUser) return;

            // Mostrar loading
            document.getElementById('user-status').innerText = "Carregando perfil...";

            const profileRef = doc(db, 'users', currentUser.uid);
            onSnapshot(profileRef, (docSnap) => {
                if (docSnap.exists()) {
                    profileData = docSnap.data();
                } else {
                    // Usar dados padr√£o locais, sem salvar ainda
                    profileData = {
                        displayName: currentUser.displayName || 'Novo Usu√°rio',
                        bio: 'Clique em editar para adicionar sua biografia...',
                        photoURL: currentUser.photoURL || '',
                        role: 'Membro'
                    };
                }
                updateUI();
                document.getElementById('user-status').innerText = "Perfil carregado";
            });

            // Carregar atividades
            const activitiesRef = collection(db, 'users', currentUser.uid, 'activities');
            onSnapshot(activitiesRef, (snap) => {
                const activities = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                document.getElementById('activities-count').innerText = activities.length;
                renderActivities(activities);
            });

            // Carregar favoritos
            const favoritesRef = collection(db, 'users', currentUser.uid, 'favorites');
            onSnapshot(favoritesRef, (snap) => {
                const favorites = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                document.getElementById('favorites-count').innerText = favorites.length;
                renderFavorites(favorites);
            });

            // Carregar artigos
            const articlesRef = collection(db, 'users', currentUser.uid, 'articles');
            onSnapshot(articlesRef, (snap) => {
                const articles = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                document.getElementById('articles-count').innerText = articles.length;
                renderArticles(articles);
            });
        }

        // Atualizar interface
        function updateUI() {
            document.getElementById('user-name').innerText = profileData.displayName || currentUser.displayName || 'Usu√°rio';
            document.getElementById('user-email').innerText = currentUser.email;
            document.getElementById('user-role').innerText = profileData.role || 'Membro';

            if (profileData.photoURL || currentUser.photoURL) {
                document.getElementById('user-photo').src = profileData.photoURL || currentUser.photoURL;
                document.getElementById('user-photo').classList.remove('hidden');
                document.getElementById('user-initial').classList.add('hidden');
            } else {
                document.getElementById('user-initial').innerText = (profileData.displayName || currentUser.displayName || 'U').charAt(0).toUpperCase();
                document.getElementById('user-photo').classList.add('hidden');
                document.getElementById('user-initial').classList.remove('hidden');
            }
        }

        // Editar perfil
        window.editProfile = () => {
            document.getElementById('edit-name').value = profileData.displayName || '';
            document.getElementById('edit-bio').value = profileData.bio || '';
            document.getElementById('edit-section').classList.toggle('hidden');
        };

        // Selecionar foto
        window.selectPhoto = () => {
            document.getElementById('photo-input').click();
        };

        // Lidar com mudan√ßa de foto
        document.getElementById('photo-input').addEventListener('change', async (event) => {
            const file = event.target.files[0];
            if (!file) return;

            if (file.size > 1024 * 1024) { // 1MB
                showMessage("A imagem √© muito grande. Escolha uma imagem de at√© 1MB.", "error");
                return;
            }

            const reader = new FileReader();
            reader.onload = async (e) => {
                const photoURL = e.target.result;
                profileData.photoURL = photoURL;
                updateUI();

                try {
                    const profileRef = doc(db, 'users', currentUser.uid);
                    await setDoc(profileRef, { photoURL }, { merge: true });
                    showMessage("Foto de perfil atualizada!", "success");
                } catch (error) {
                    console.error(error);
                    showMessage("Erro ao salvar foto.", "error");
                }
            };
            reader.readAsDataURL(file);
        });

        // Salvar perfil
        document.getElementById('edit-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!currentUser) return;

            const newName = document.getElementById('edit-name').value;
            const newBio = document.getElementById('edit-bio').value;

            try {
                const profileRef = doc(db, 'users', currentUser.uid);
                await setDoc(profileRef, {
                    displayName: newName,
                    bio: newBio
                }, { merge: true });
                profileData.displayName = newName;
                profileData.bio = newBio;
                updateUI();
                document.getElementById('edit-section').classList.add('hidden');
                showMessage("Perfil atualizado com sucesso!", "success");
            } catch (error) {
                console.error(error);
                showMessage("Erro ao atualizar perfil.", "error");
            }
        });

        // Logout
        window.handleLogout = async () => {
            try {
                await signOut(auth);
                window.location.href = 'login.html';
            } catch (error) {
                console.error(error);
                showMessage("Erro ao sair.", "error");
            }
        };

        // Mostrar aba
        window.showTab = (tab) => {
            document.querySelectorAll('#tab-content > div').forEach(div => div.classList.add('hidden'));
            document.getElementById(tab + '-list').classList.remove('hidden');

            document.querySelectorAll('button[id^="tab-"]').forEach(btn => {
                btn.classList.remove('bg-indigo-600', 'text-white');
                btn.classList.add('text-gray-500', 'hover:bg-gray-50');
            });
            document.getElementById('tab-' + tab).classList.add('bg-indigo-600', 'text-white');
            document.getElementById('tab-' + tab).classList.remove('text-gray-500', 'hover:bg-gray-50');
        };

        // Renderizar atividades
        function renderActivities(activities) {
            const list = document.getElementById('activities-list');
            list.innerHTML = activities.length > 0 
                ? activities.map(item => `
                    <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-200">
                        <h4 class="font-bold text-gray-800">${item.title || 'Atividade'}</h4>
                        <p class="text-sm text-gray-500">${item.date || 'Data n√£o dispon√≠vel'}</p>
                    </div>
                `).join('')
                : '<p class="text-center text-gray-500">Nenhuma atividade encontrada.</p>';
        }

        // Renderizar favoritos
        function renderFavorites(favorites) {
            const list = document.getElementById('favorites-list');
            list.innerHTML = favorites.length > 0 
                ? favorites.map(item => `
                    <a href="${item.url || '#'}" class="block bg-white p-4 rounded-xl shadow-sm border border-amber-200 hover:shadow-md transition">
                        <div class="flex items-center space-x-4">
                            <img src="${item.image || '/Assets/placeholder.png'}" alt="${item.title}" class="w-16 h-16 object-cover rounded-lg">
                            <div>
                                <h4 class="font-bold text-gray-800">${item.title || 'Favorito'}</h4>
                                <p class="text-sm text-gray-500">${new Date(item.date).toLocaleDateString('pt-BR')}</p>
                            </div>
                        </div>
                    </a>
                `).join('')
                : '<p class="text-center text-gray-500">Nenhum favorito encontrado.</p>';
        }

        // Renderizar artigos
        function renderArticles(articles) {
            const list = document.getElementById('articles-list');
            list.innerHTML = articles.length > 0 
                ? articles.map(item => `
                    <a href="${item.url || '#'}" class="block bg-white p-4 rounded-xl shadow-sm border border-rose-200 hover:shadow-md transition">
                        <div class="flex items-center space-x-4">
                            <img src="${item.image || '/Assets/article-placeholder.png'}" alt="${item.title}" class="w-16 h-16 object-cover rounded-lg">
                            <div>
                                <h4 class="font-bold text-gray-800">${item.title || 'Artigo'}</h4>
                                <p class="text-sm text-gray-500">${new Date(item.date).toLocaleDateString('pt-BR')}</p>
                            </div>
                        </div>
                    </a>
                `).join('')
                : '<p class="text-center text-gray-500">Nenhum artigo encontrado.</p>';
        }

        // Mostrar mensagem
        function showMessage(msg, type) {
            const box = document.getElementById('message-box');
            box.innerText = msg;
            box.className = `mx-8 mb-8 p-3 rounded-lg text-sm text-center ${type === 'error' ? 'bg-red-100 text-red-600' : 'bg-green-100 text-green-600'}`;
            box.classList.remove('hidden');
            setTimeout(() => box.classList.add('hidden'), 3000);
        }
    </script>
</body>
</html>