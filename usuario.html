<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Perfil do Usuário - ${new Date(item.date).toLocaleDateString('pt-BR')}">
    <title>Perfil do Usuário - Atividade Adaptada</title>
    <link rel="shortcut icon" href="/Assets/favicon.ico" type="image/x-icon">
    <link rel="canonical" href="https://www.atividadeadaptada.com.br/usuario.html">
    <meta property="og:title" content="Perfil do Usuário - Atividade Adaptada">
    <meta property="og:description" content="Conteúdo educativo de qualidade">
    <meta name="twitter:card" content="summary_large_image">
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts: Nunito, uma fonte amigável e legível -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;700;800&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Nunito', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .card-hover {
            transition: all 0.3s ease-in-out;
        }
        .card-hover:hover {
            transform: translateY(-8px);
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.15);
        }
        .profile-header-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .avatar-pulse {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        @keyframes pulse {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: 0.8;
            }
        }
        .stat-card {
            transition: all 0.3s ease;
        }
        .stat-card:hover {
            transform: scale(1.05);
        }
        .tab-active {
            border-bottom: 3px solid #667eea;
        }
    </style>

    <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "EducationalActivity",
      "name": "Perfil do Usuário - Atividade Adaptada",
      "description": "Conteúdo educativo de qualidade",
      "author": {
        "@type": "Organization",
        "@name": "Atividade Adaptada"
      },
      "inLanguage": "pt-BR"
    }
    </script>
</head>
<body class="text-gray-800">

    <!-- Cabeçalho e Navegação -->
    <header class="bg-white shadow-lg sticky top-0 z-50">
        <nav class="container mx-auto px-4 sm:px-6 py-4 flex justify-between items-center">
            <a href="index.html" class="text-lg sm:text-2xl font-extrabold">
                <span class="text-red-600">Atividade</span><span class="text-blue-600">Adaptada</span><span class="text-gray-900">.com</span>
            </a>
            <div class="hidden md:flex items-center space-x-6">
                <a href="index.html" class="font-bold text-purple-600 hover:text-purple-700">Início</a>
                <a href="nivel-2/categorias.html" class="text-gray-600 hover:text-purple-600 transition">Atividades</a>
                <a href="nivel-2/1-pagina-inicial/1-Paginas/Artigos.html" class="text-gray-600 hover:text-purple-600 transition">Artigos</a>
                <a href="nivel-2/6-Quem-Somos.html" class="text-gray-600 hover:text-purple-600 transition">Sobre Nós</a>
            </div>
            <button onclick="handleLogout()" class="hidden md:block bg-gradient-to-r from-orange-500 to-orange-600 text-white font-bold py-2 px-5 rounded-full hover:shadow-lg transition">
                Sair
            </button>
            <button id="mobile-menu-button" class="md:hidden p-2 hover:bg-gray-100 rounded-lg">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7" /></svg>
            </button>
        </nav>
        <div id="mobile-menu" class="hidden md:hidden px-4 pb-4 bg-gray-50 border-t">
            <a href="index.html" class="block py-2 font-bold text-purple-600">Início</a>
            <a href="nivel-2/categorias.html" class="block py-2 text-gray-600 hover:text-purple-600">Atividades</a>
            <a href="nivel-2/1-pagina-inicial/1-Paginas/Artigos.html" class="block py-2 text-gray-600 hover:text-purple-600">Artigos</a>
            <a href="nivel-2/6-Quem-Somos.html" class="block py-2 text-gray-600 hover:text-purple-600">Sobre Nós</a>
            <button onclick="handleLogout()" class="block mt-4 w-full bg-gradient-to-r from-orange-500 to-orange-600 text-white font-bold py-2 px-5 rounded-lg">Sair</button>
        </div>
    </header>

    <main id="profile-container" class="hidden py-8 px-4 sm:px-6 container mx-auto max-w-4xl">

        <!-- Card Principal -->
        <div class="bg-white rounded-3xl shadow-2xl overflow-hidden card-hover mb-6">
            
            <!-- Header com Gradiente -->
            <div class="profile-header-bg h-32 sm:h-40 relative">
                <div class="absolute inset-0 opacity-20" style="background-image: url('data:image/svg+xml,%3Csvg width=%2720%27 height=%2720%27 xmlns=%27http://www.w3.org/2000/svg%27%3E%3Cg fill=%27%23fff%27 fill-rule=%27evenodd%27%3E%3Ccircle cx=%2710%27 cy=%2710%27 r=%271%27/%3E%3C/g%3E%3C/svg%3E')"></div>
            </div>

            <!-- Informações do Perfil -->
            <div class="px-4 sm:px-8 pb-8">
                <div class="flex flex-col sm:flex-row items-start sm:items-end gap-4 -mt-16 mb-6">
                    <!-- Avatar -->
                    <div id="user-photo-container" class="relative">
                        <img id="user-photo" src="" class="w-32 h-32 rounded-2xl border-4 border-white shadow-lg object-cover hidden">
                        <div id="user-initial" class="w-32 h-32 bg-gradient-to-br from-purple-400 to-purple-600 text-white rounded-2xl flex items-center justify-center text-5xl font-bold border-4 border-white shadow-lg">U</div>
                        <button onclick="selectPhoto()" class="absolute bottom-2 right-2 bg-white text-purple-600 p-3 rounded-full shadow-lg hover:shadow-xl hover:scale-110 transition">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z" /></svg>
                        </button>
                    </div>
                    <input type="file" id="photo-input" accept="image/*" style="display: none;">

                    <!-- Dados do Perfil -->
                    <div class="flex-1 w-full">
                        <h1 id="user-name" class="text-2xl sm:text-4xl font-bold text-gray-900 mb-1">Usuário</h1>
                        <p id="user-email" class="text-sm sm:text-base text-gray-500 mb-2"></p>
                        <div class="flex gap-3 flex-wrap">
                            <span id="user-role" class="inline-block px-3 py-1 bg-purple-100 text-purple-700 rounded-full text-sm font-semibold">Membro</span>
                            <span id="user-status" class="inline-block px-3 py-1 bg-green-100 text-green-700 rounded-full text-sm font-semibold">Ativo</span>
                        </div>
                    </div>
                </div>

                <!-- Botões de Ação -->
                <div class="flex flex-col sm:flex-row gap-3 mb-8">
                    <button onclick="editProfile()" class="flex-1 bg-gradient-to-r from-purple-600 to-purple-700 hover:from-purple-700 hover:to-purple-800 text-white font-bold py-3 px-6 rounded-xl transition shadow-md hover:shadow-lg">
                        ✏️ Editar Perfil
                    </button>
                    <button onclick="handleLogout()" class="flex-1 border-2 border-red-300 text-red-600 hover:bg-red-50 font-bold py-3 px-6 rounded-xl transition">
                        🚪 Sair
                    </button>
                </div>

                <!-- Seção de Edição (oculta por padrão) -->
                <div id="edit-section" class="hidden mb-8 p-6 bg-gradient-to-br from-purple-50 to-pink-50 rounded-2xl border-2 border-purple-100">
                    <h3 class="text-2xl font-bold text-gray-900 mb-6">Editar Meu Perfil</h3>
                    <form id="edit-form" class="space-y-4">
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Nome Completo</label>
                            <input type="text" id="edit-name" placeholder="Digite seu nome" class="w-full px-4 py-3 rounded-xl border-2 border-purple-200 focus:border-purple-500 focus:ring-2 focus:ring-purple-300 outline-none transition">
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Sobre Você</label>
                            <textarea id="edit-bio" placeholder="Conte-nos um pouco sobre você..." class="w-full px-4 py-3 rounded-xl border-2 border-purple-200 focus:border-purple-500 focus:ring-2 focus:ring-purple-300 outline-none transition h-24 resize-none"></textarea>
                        </div>
                        <div class="flex gap-3 pt-4">
                            <button type="submit" class="flex-1 bg-gradient-to-r from-green-500 to-green-600 hover:from-green-600 hover:to-green-700 text-white font-bold py-3 rounded-xl shadow-md hover:shadow-lg transition">
                                ✓ Salvar Alterações
                            </button>
                            <button type="button" onclick="editProfile()" class="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-3 rounded-xl transition">
                                ✕ Cancelar
                            </button>
                        </div>
                    </form>
                </div>

                <!-- Estatísticas -->
                <div class="grid grid-cols-3 gap-3 mb-8">
                    <div class="stat-card bg-gradient-to-br from-purple-50 to-purple-100 p-4 rounded-2xl text-center border-2 border-purple-200">
                        <p id="activities-count" class="text-3xl sm:text-4xl font-bold text-purple-600">0</p>
                        <p class="text-xs sm:text-sm text-purple-700 font-semibold mt-2">Atividades</p>
                    </div>
                    <div class="stat-card bg-gradient-to-br from-amber-50 to-amber-100 p-4 rounded-2xl text-center border-2 border-amber-200">
                        <p id="favorites-count" class="text-3xl sm:text-4xl font-bold text-amber-600">0</p>
                        <p class="text-xs sm:text-sm text-amber-700 font-semibold mt-2">Favoritos</p>
                    </div>
                    <div class="stat-card bg-gradient-to-br from-pink-50 to-pink-100 p-4 rounded-2xl text-center border-2 border-pink-200">
                        <p id="articles-count" class="text-3xl sm:text-4xl font-bold text-pink-600">0</p>
                        <p class="text-xs sm:text-sm text-pink-700 font-semibold mt-2">Artigos</p>
                    </div>
                </div>

                <!-- Abas -->
                <div class="border-b-2 border-gray-200 mb-6">
                    <div class="flex gap-4 overflow-x-auto">
                        <button onclick="showTab('activities')" id="tab-activities" class="tab-active pb-4 px-1 font-bold text-purple-600 border-b-4 border-purple-600 whitespace-nowrap">
                            📚 Atividades
                        </button>
                        <button onclick="showTab('favorites')" id="tab-favorites" class="pb-4 px-1 font-bold text-gray-500 hover:text-purple-600 whitespace-nowrap">
                            ⭐ Favoritos
                        </button>
                        <button onclick="showTab('articles')" id="tab-articles" class="pb-4 px-1 font-bold text-gray-500 hover:text-purple-600 whitespace-nowrap">
                            📰 Artigos
                        </button>
                    </div>
                </div>

                <!-- Conteúdo das Abas -->
                <div id="tab-content">
                    <div id="activities-list" class="space-y-4">
                        <div class="text-center py-8 text-gray-400">
                            <p class="text-lg">📭 Nenhuma atividade encontrada</p>
                        </div>
                    </div>
                    <div id="favorites-list" class="space-y-4 hidden">
                        <div class="text-center py-8 text-gray-400">
                            <p class="text-lg">📭 Nenhum favorito encontrado</p>
                        </div>
                    </div>
                    <div id="articles-list" class="space-y-4 hidden">
                        <div class="text-center py-8 text-gray-400">
                            <p class="text-lg">📭 Nenhum artigo encontrado</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Caixa de Mensagens -->
        <div id="message-box" class="hidden fixed bottom-6 right-6 left-6 sm:left-auto sm:w-96 p-4 rounded-xl shadow-2xl text-center font-semibold animate-pulse"></div>

    </main>

    <!-- Scripts -->
    <script>
        document.getElementById('mobile-menu-button').addEventListener('click', () => {
            document.getElementById('mobile-menu').classList.toggle('hidden');
        });
    </script>

    <!-- Scripts Firebase -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            onAuthStateChanged, 
            signOut
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            setDoc, 
            onSnapshot, 
            collection,
            updateDoc
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDmMuftAqoUBEoGHXtV0C_SZVHp5KmdNn4",
            authDomain: "atividadeadaptada.firebaseapp.com",
            projectId: "atividadeadaptada",
            storageBucket: "atividadeadaptada.firebasestorage.app",
            messagingSenderId: "37982590936",
            appId: "1:37982590936:web:f0bd7b5c5dd208e26a84ad"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let currentUser = null;
        let profileData = {};

        // Verificar autenticação
        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                loadUserProfile();
                document.getElementById('profile-container').classList.remove('hidden');
                document.getElementById('user-status').innerText = "Perfil carregado";
            } else {
                // Se não logado, redirecionar para login
                window.location.href = 'login.html';
            }
        });

        // Carregar perfil do usuário
        function loadUserProfile() {
            if (!currentUser) return;

            // Mostrar loading
            document.getElementById('user-status').innerText = "Carregando perfil...";

            const profileRef = doc(db, 'users', currentUser.uid);
            onSnapshot(profileRef, (docSnap) => {
                if (docSnap.exists()) {
                    profileData = docSnap.data();
                } else {
                    // Usar dados padrão locais, sem salvar ainda
                    profileData = {
                        displayName: currentUser.displayName || 'Novo Usuário',
                        bio: 'Clique em editar para adicionar sua biografia...',
                        photoURL: currentUser.photoURL || '',
                        role: 'Membro'
                    };
                }
                updateUI();
                document.getElementById('user-status').innerText = "Perfil carregado";
            });

            // Carregar atividades
            const activitiesRef = collection(db, 'users', currentUser.uid, 'activities');
            onSnapshot(activitiesRef, (snap) => {
                const activities = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                document.getElementById('activities-count').innerText = activities.length;
                renderActivities(activities);
            });

            // Carregar favoritos
            const favoritesRef = collection(db, 'users', currentUser.uid, 'favorites');
            onSnapshot(favoritesRef, (snap) => {
                const favorites = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                document.getElementById('favorites-count').innerText = favorites.length;
                renderFavorites(favorites);
            });

            // Carregar artigos
            const articlesRef = collection(db, 'users', currentUser.uid, 'articles');
            onSnapshot(articlesRef, (snap) => {
                const articles = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                document.getElementById('articles-count').innerText = articles.length;
                renderArticles(articles);
            });
        }

        // Atualizar interface
        function updateUI() {
            document.getElementById('user-name').innerText = profileData.displayName || currentUser.displayName || 'Usuário';
            document.getElementById('user-email').innerText = currentUser.email;
            document.getElementById('user-role').innerText = profileData.role || 'Membro';

            if (profileData.photoURL || currentUser.photoURL) {
                document.getElementById('user-photo').src = profileData.photoURL || currentUser.photoURL;
                document.getElementById('user-photo').classList.remove('hidden');
                document.getElementById('user-initial').classList.add('hidden');
            } else {
                document.getElementById('user-initial').innerText = (profileData.displayName || currentUser.displayName || 'U').charAt(0).toUpperCase();
                document.getElementById('user-photo').classList.add('hidden');
                document.getElementById('user-initial').classList.remove('hidden');
            }
        }

        // Editar perfil
        window.editProfile = () => {
            document.getElementById('edit-name').value = profileData.displayName || '';
            document.getElementById('edit-bio').value = profileData.bio || '';
            document.getElementById('edit-section').classList.toggle('hidden');
        };

        // Selecionar foto
        window.selectPhoto = () => {
            document.getElementById('photo-input').click();
        };

        // Lidar com mudança de foto
        document.getElementById('photo-input').addEventListener('change', async (event) => {
            const file = event.target.files[0];
            if (!file) return;

            if (file.size > 1024 * 1024) { // 1MB
                showMessage("A imagem é muito grande. Escolha uma imagem de até 1MB.", "error");
                return;
            }

            const reader = new FileReader();
            reader.onload = async (e) => {
                const photoURL = e.target.result;
                profileData.photoURL = photoURL;
                updateUI();

                try {
                    const profileRef = doc(db, 'users', currentUser.uid);
                    await setDoc(profileRef, { photoURL }, { merge: true });
                    showMessage("Foto de perfil atualizada!", "success");
                } catch (error) {
                    console.error(error);
                    showMessage("Erro ao salvar foto.", "error");
                }
            };
            reader.readAsDataURL(file);
        });

        // Salvar perfil
        document.getElementById('edit-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!currentUser) return;

            const newName = document.getElementById('edit-name').value;
            const newBio = document.getElementById('edit-bio').value;

            try {
                const profileRef = doc(db, 'users', currentUser.uid);
                await setDoc(profileRef, {
                    displayName: newName,
                    bio: newBio
                }, { merge: true });
                profileData.displayName = newName;
                profileData.bio = newBio;
                updateUI();
                document.getElementById('edit-section').classList.add('hidden');
                showMessage("Perfil atualizado com sucesso!", "success");
            } catch (error) {
                console.error(error);
                showMessage("Erro ao atualizar perfil.", "error");
            }
        });

        // Logout
        window.handleLogout = async () => {
            try {
                await signOut(auth);
                window.location.href = 'login.html';
            } catch (error) {
                console.error(error);
                showMessage("Erro ao sair.", "error");
            }
        };

        // Mostrar aba
        window.showTab = (tab) => {
            document.querySelectorAll('#tab-content > div').forEach(div => div.classList.add('hidden'));
            document.getElementById(tab + '-list').classList.remove('hidden');

            document.querySelectorAll('button[id^="tab-"]').forEach(btn => {
                btn.classList.remove('tab-active', 'text-purple-600', 'border-b-4', 'border-purple-600');
                btn.classList.add('text-gray-500', 'hover:text-purple-600');
            });
            document.getElementById('tab-' + tab).classList.add('tab-active', 'text-purple-600', 'border-b-4', 'border-purple-600');
        };

        // Renderizar atividades
        function renderActivities(activities) {
            const list = document.getElementById('activities-list');
            list.innerHTML = activities.length > 0 
                ? activities.map(item => `
                    <div class="bg-gradient-to-r from-purple-50 to-white p-4 rounded-xl border-l-4 border-purple-500 shadow-sm hover:shadow-md transition card-hover">
                        <h4 class="font-bold text-gray-900 text-lg">${item.title || 'Atividade'}</h4>
                        <p class="text-sm text-gray-500 mt-1">📅 ${item.date || 'Data não disponível'}</p>
                    </div>
                `).join('')
                : '<div class="text-center py-8 text-gray-400"><p class="text-lg">📭 Nenhuma atividade encontrada</p></div>';
        }

        // Renderizar favoritos
        function renderFavorites(favorites) {
            const list = document.getElementById('favorites-list');
            list.innerHTML = favorites.length > 0 
                ? favorites.map(item => `
                    <a href="${item.url || '#'}" class="block bg-white p-4 rounded-xl border-l-4 border-amber-500 shadow-sm hover:shadow-lg transition card-hover">
                        <div class="flex items-center gap-4">
                            <img src="${item.image || '/Assets/placeholder.png'}" alt="${item.title}" class="w-16 h-16 object-cover rounded-lg flex-shrink-0">
                            <div class="flex-1 min-w-0">
                                <h4 class="font-bold text-gray-900 truncate">${item.title || 'Favorito'}</h4>
                                <p class="text-sm text-gray-500">⭐ ${new Date(item.date).toLocaleDateString('pt-BR')}</p>
                            </div>
                        </div>
                    </a>
                `).join('')
                : '<div class="text-center py-8 text-gray-400"><p class="text-lg">📭 Nenhum favorito encontrado</p></div>';
        }

        // Renderizar artigos
        function renderArticles(articles) {
            const list = document.getElementById('articles-list');
            list.innerHTML = articles.length > 0 
                ? articles.map(item => `
                    <a href="${item.url || '#'}" class="block bg-white p-4 rounded-xl border-l-4 border-pink-500 shadow-sm hover:shadow-lg transition card-hover">
                        <div class="flex items-center gap-4">
                            <img src="${item.image || '/Assets/article-placeholder.png'}" alt="${item.title}" class="w-16 h-16 object-cover rounded-lg flex-shrink-0">
                            <div class="flex-1 min-w-0">
                                <h4 class="font-bold text-gray-900 truncate">${item.title || 'Artigo'}</h4>
                                <p class="text-sm text-gray-500">📰 ${new Date(item.date).toLocaleDateString('pt-BR')}</p>
                            </div>
                        </div>
                    </a>
                `).join('')
                : '<div class="text-center py-8 text-gray-400"><p class="text-lg">📭 Nenhum artigo encontrado</p></div>';
        }

        // Mostrar mensagem
        function showMessage(msg, type) {
            const box = document.getElementById('message-box');
            box.innerText = msg;
            box.className = `fixed bottom-6 right-6 left-6 sm:left-auto sm:w-96 p-4 rounded-xl shadow-2xl text-center font-semibold ${type === 'error' ? 'bg-red-500 text-white' : 'bg-green-500 text-white'}`;
            box.classList.remove('hidden');
            setTimeout(() => box.classList.add('hidden'), 3000);
        }
    </script>
</body>
</html>